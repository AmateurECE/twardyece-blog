---
layout: post
title: "Dependency Injection for redfish-codegen, Part 4"
date: 2023-07-15 15:00:00 -0500
categories: redfish
---

# Status of the project

I just released v0.3.1 of the redfish-codegen project. This release brings the
new dependency-injection-based API that we have been working so hard on
throughout this series, and it also brings support for the 2023.1 version of
the Redfish data model. This version is stable enough to use for application
development, though it is missing some bells and whistles--which we'll be
working towards from now on in this series.

# Events

The first great missing link in the framework is a suitable solution for
events. Let's quickly review Redfish events so that we can design a solution
that works in the best interest of the implementors, and meets the
requirements in the standard. The Redfish Resource and Schema Guide (DSP2046)
and the Redfish Data Model Specification (DSP0268) are critical documents for
understanding the use within the specification.

Events are defined in a _MessageRegistry_. The DMTF defines a set of standard
message registries, which are available as part of DSP8011. The
redfish-codegen crate generates Rust code from these registries, which are
[currently implemented as enumerations][1]. Registries can also be provided by
a Redfish service, usually at the URL `/redfish/v1/Registries`.

These events can appear in multiple locations, but the common thread is the
existence of a `MessageId` property:

1. A service may respond to an HTTP operation with a [RedfishError][2]. This
  struct contains a `MessageId`, but it may also contain one or more
  [Message][3] instances, which each also contain a `MessageId` property.
2. Events: These can be sent asynchronously to destinations configured through
  the [EventService][4], or across an SSE stream.
3. Log entries: From the Redfish Resource and Schema Guide (DSO2046), "The
  [LogEntry][5] schema defines the record format for a log. It is designed for
  Redfish event logs, OEM-specific log formats, and the IPMI System Event Log
  (SEL)." A [LogService][6] can be mounted on a compute resource--e.g. a
  Chassis, ComputerSystem, or Manager--via a LogServiceCollection, or at the
  service level by mounting on a JobService or TelemetryService instance.

Knowing now where log entries will appear in the service, let's clarify our
use cases:

1. As a Redfish implementor, I want to be able to generate events from any
  location in the service, without needing to inject dependencies for log
  entry creation--logging is a cross-cutting concern, so we want to avoid
  polluting our code with passing around logging-related dependencies.
2. As a Redfish implementor, I want the event generation mechanism to
  integrate seamlessly with the Rust tracing subsystem, so that I can get
  tracing for free (even from the standard components available in Seuss) in
  the applications where I choose to leverage tracing.
3. As a Redfish implementor, I want to be able to write components that can
  receive and handle events generated by the service, so that I can dispatch
  Redfish events in ways not supported by the Seuss framework--e.g. by writing
  a custom SMTP event dispatcher or LogService.

Unfortunately, we can't leverage the `tracing` crate for this directly,
because even though the tracing macros accept structured data, this data is
converted to a string before being dispatched to the logger.

Our next available move is to take a look at how the tracing crate _works_,
and to reason about a solution that would fulfill our use cases by potentially
leveraging some similar mechanisms.

[1]: https://docs.rs/redfish-codegen/0.3.1/redfish_codegen/registries/index.html
[2]: https://docs.rs/redfish-codegen/0.3.1/redfish_codegen/models/redfish/struct.RedfishError.html
[3]: https://docs.rs/redfish-codegen/0.3.1/redfish_codegen/models/message/v1_1_2/struct.Message.html
[4]: https://docs.rs/redfish-axum/0.3.1/redfish_axum/event_service/struct.EventService.html
[5]: https://docs.rs/redfish-codegen/0.3.1/redfish_codegen/models/log_entry/v1_15_0/struct.LogEntry.html
[6]: https://docs.rs/redfish-axum/0.3.1/redfish_axum/log_service/struct.LogService.html
